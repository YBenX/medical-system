# 门诊诊疗系统需求文档

## 项目概述
开发一个基于AI会话的门诊诊疗管理系统，模拟医生助理或前台人员的角色，在会话框中输入需求（比如"给张丽预约刘洋医生10月5日下午的号"），通过自然语言对话方式完成患者建档、预约挂号、医生看诊、填写病历、处方开具和收费等完整门诊流程。

### 项目目标
- 提升门诊工作效率，减少人工操作成本
- 提供智能化、人性化的就诊体验
- 实现完整的诊疗流程数字化管理
- 建立可扩展的医疗AI应用框架

### 应用场景
- 小型诊所门诊管理
- 社区医疗服务中心
- 企业医务室
- 医疗AI产品原型验证

## 技术栈
- **前端**: Vue 3 + Element UI Plus
- **后端**: .NET 9
- **数据库**: SQLite
- **AI集成**: DeepSeek / Qwen 大模型 API

## 核心功能模块

### 1. AI会话交互系统
- **自然语言理解**
  - 基于大模型的对话管理和意图识别
  - 支持多轮对话上下文记忆（至少保持20轮历史）
  - 智能识别用户意图（建档/挂号/看诊/查询/收费等）
  - 支持同义词识别和口语化表达理解

- **智能引导与信息收集**
  - 当信息不完整时，主动询问并引导用户补充
  - 支持信息确认和修正（"您的意思是...吗？"）
  - 提供智能建议（推荐科室、医生、时间等）

- **多模式交互**
  - 纯文本对话模式
  - 结构化表单弹窗模式
  - 内联表单编辑模式
  - 快捷指令支持（如"/挂号"、"/查询"等）

- **对话管理**
  - 会话状态跟踪（建档中/挂号中/看诊中等）
  - 支持打断和上下文切换
  - 错误理解的纠正和重试机制
  - 会话超时和自动保存

### 2. 患者建档模块
- **基本信息**（必填项）
  - 姓名（2-50字符）
  - 性别（男/女/其他）
  - 出生日期或年龄
  - 身份证号（18位，支持校验）
  - 联系电话（11位手机号）

- **扩展信息**（选填项）
  - 家庭住址
  - 紧急联系人及电话
  - 医保卡号
  - 职业信息

- **病史信息**
  - 过敏史（药物、食物等）
  - 既往病史（高血压、糖尿病等慢性病）
  - 家族病史（遗传性疾病）
  - 手术史

- **智能功能**
  - AI辅助信息收集和验证
  - 自动去重检测（姓名+身份证/电话）
  - 信息完整度评估
  - 历史就诊记录自动关联

### 3. 预约挂号模块
- **科室选择**
  - 支持科室列表：内科、外科、儿科、妇科、中医科等
  - AI智能推荐科室（根据症状描述）
  - 科室介绍和特色展示

- **医生选择**
  - 医生详细信息展示
    - 姓名、职称（主任/副主任/主治/住院医师）
    - 擅长领域和专业特长
    - 患者评价和评分（可选）
  - 实时排班查询
  - AI推荐医生（根据病情匹配）

- **时间选择**
  - 日期选择（支持未来7-30天）
  - 时段选择（上午/下午/晚间）
  - 具体时间段显示（如：上午9:00-12:00）
  - 节假日和休息日标注

- **号源管理**
  - 实时号源数量显示
  - 号源不足预警
  - 候补排队功能（可选）
  - 预约号码生成

- **预约操作**
  - 预约确认（短信/系统通知）
  - 预约修改（改期/换医生）
  - 预约取消（提前24小时）
  - 爽约记录管理

### 4. 医生看诊模块
- **患者信息查看**: 调取患者档案和历史病历
- **主诉记录**: AI辅助记录患者主诉
- **诊断记录**:
  - 现病史、体格检查
  - 初步诊断和确诊
  - ICD-10 疾病编码支持
- **病历生成**: 自动整理对话内容生成规范病历
- **处方开具**:
  - 药品搜索和选择
  - 用法用量设定
  - 药品相互作用检查
  - 处方合理性审核

### 5. 收费模块
- **费用项目**:
  - 挂号费
  - 诊疗费
  - 药品费
  - 检查费
- **费用计算**: 自动汇总各项费用
- **收费记录**: 生成收费清单和发票
- **支付状态**: 已支付/未支付标记

### 6. 查询和统计模块
- 患者就诊记录查询
- 医生工作量统计
- 收费统计报表
- 药品使用统计

## 数据库设计要点

### 核心表结构
1. **患者表 (Patients)**
   - 患者ID、姓名、性别、出生日期、身份证号、联系方式
   - 过敏史、既往病史、家族病史
   - 创建时间、更新时间

2. **医生表 (Doctors)**
   - 医生ID、姓名、职称、科室
   - 擅长领域、简介
   - 状态（在职/离职）

3. **排班表 (Schedules)**
   - 排班ID、医生ID、日期、时段
   - 总号源数、剩余号源数

4. **预约表 (Appointments)**
   - 预约ID、患者ID、医生ID、排班ID
   - 预约时间、就诊时间
   - 状态（已预约/已就诊/已取消）

5. **病历表 (MedicalRecords)**
   - 病历ID、患者ID、医生ID、就诊日期
   - 主诉、现病史、体格检查
   - 诊断、ICD编码

6. **处方表 (Prescriptions)**
   - 处方ID、病历ID、开方医生ID
   - 处方日期、状态

7. **处方明细表 (PrescriptionDetails)**
   - 明细ID、处方ID、药品ID
   - 用法、用量、数量、单价

8. **药品表 (Medicines)**
   - 药品ID、药品名称、规格
   - 单位、单价、库存
   - 分类、说明

9. **收费表 (Charges)**
   - 收费ID、患者ID、病历ID
   - 费用明细（JSON）、总金额
   - 支付状态、支付时间

10. **会话记录表 (ConversationHistory)**
    - 会话ID、患者ID、医生ID（可选）
    - 消息内容、发送者角色（用户/AI/系统）
    - 消息时间、关联业务ID

## AI集成方案

### API配置
- 支持配置多个AI模型提供商（DeepSeek、Qwen）
- API密钥管理
- 模型参数配置（temperature、max_tokens等）
- 备用模型切换机制

### Prompt工程
- **系统角色设定**
  ```
  你是一位专业的医疗助理，负责协助患者完成门诊流程。
  你需要：
  1. 用友好、专业的语言与患者交流
  2. 准确理解患者需求并提供帮助
  3. 在信息不完整时主动询问
  4. 保护患者隐私，谨慎处理敏感信息
  5. 遇到紧急情况及时提醒就医
  ```

- **上下文管理**
  - 会话历史维护（用户消息+AI回复）
  - 患者档案信息上下文注入
  - 当前业务流程状态跟踪
  - 相关数据的动态加载（医生、排班等）

- **意图识别规则**
  - 建档意图：包含"建档"、"登记"、"第一次来"等
  - 挂号意图：包含"预约"、"挂号"、"看病"等
  - 查询意图：包含"查询"、"查看"、"什么时候"等
  - 取消意图：包含"取消"、"不去了"等
  - 收费意图：包含"缴费"、"付款"、"多少钱"等

- **信息提取模板**
  ```json
  {
    "intent": "建档/挂号/查询/...",
    "entities": {
      "patient_name": "张丽",
      "doctor_name": "刘洋",
      "date": "10月5日",
      "time_period": "下午"
    },
    "missing_fields": ["contact_phone"],
    "confidence": 0.95
  }
  ```

- **输出控制**
  - 支持Markdown格式化输出
  - 表单嵌入指令（触发前端表单渲染）
  - 结构化数据返回（JSON格式）
  - 错误提示和建议输出

### 对话流程示例

#### 示例1：完整挂号流程
```
用户: 我想预约挂号
AI: 好的，请问您是否已经在我院建档？

用户: 还没有
AI: 我来帮您建档。请提供您的基本信息：
   - 姓名：
   - 性别：
   - 出生日期：
   - 联系电话：
   - 身份证号：
   您也可以点击 [填写表单] 快速完成建档。

用户: 张丽，女，1990-05-20，13812345678，320106199005201234
AI: 好的，已为您创建档案：
   姓名：张丽
   性别：女
   年龄：35岁
   联系电话：138****5678
   请问您需要预约哪个科室？或者您可以告诉我您的症状，我来推荐合适的科室。

用户: 最近感冒咳嗽
AI: 根据您的症状，建议挂内科。我院内科有以下医生：
   1. 刘洋医生 - 主任医师，擅长呼吸系统疾病
   2. 王芳医生 - 副主任医师，擅长内科常见病
   请问您需要预约哪位医生？

用户: 刘洋医生
AI: 好的，刘洋医生近期排班如下：
   10月4日（周五）上午 - 剩余3个号
   10月5日（周六）下午 - 剩余5个号
   10月7日（周一）上午 - 剩余8个号
   请问您想预约哪个时间？

用户: 10月5日下午
AI: 好的，已为您预约：
   患者：张丽
   医生：刘洋（主任医师）
   时间：2025年10月5日 下午 14:00-17:00
   预约号：A0052

   请您提前15分钟到达诊室，预约成功！需要其他帮助吗？
```

#### 示例2：快速挂号（已建档患者）
```
用户: 给张丽预约刘洋医生10月5日下午的号
AI: 正在为您处理...
   已找到患者：张丽（138****5678）
   已找到医生：刘洋（内科，主任医师）
   10月5日下午有号，正在预约...

   预约成功！
   预约信息：
   - 就诊时间：2025年10月5日 下午 14:00-17:00
   - 预约号：A0052
   - 诊室：内科2号诊室

   请提前15分钟到达，祝您早日康复！
```

#### 示例3：查询预约
```
用户: 查一下张丽的预约记录
AI: 已为您查询到张丽的预约记录：

   【近期预约】
   1. 2025-10-05 下午 刘洋医生（内科）- 已预约

   【历史就诊】
   1. 2025-09-15 上午 王芳医生（内科）- 已完成
      诊断：上呼吸道感染
   2. 2025-08-20 下午 李明医生（外科）- 已完成
      诊断：皮肤擦伤

   需要取消或修改预约吗？
```

## 前端技术要求

### 组件设计
- 会话组件：消息列表、输入框、快捷操作按钮
- 表单组件：动态表单生成器
- 患者卡片：展示患者基本信息
- 病历查看器：历史病历浏览
- 处方编辑器：药品搜索和添加

### 交互体验
- 流式输出AI回复（打字机效果）
- 消息状态指示（发送中/成功/失败）
- 表单验证和错误提示
- 响应式布局，支持移动端

### Element UI Plus组件使用
- el-container: 页面布局
- el-form: 表单
- el-table: 数据列表
- el-dialog: 弹窗
- el-button: 按钮
- el-select: 下拉选择
- el-date-picker: 日期选择
- el-card: 卡片
- el-message: 消息提示

## 后端技术要求

### API设计
采用RESTful风格，主要接口：

- `POST /api/chat/send` - 发送会话消息
- `GET /api/chat/history/{sessionId}` - 获取会话历史
- `POST /api/patients` - 创建患者档案
- `GET /api/patients/{id}` - 获取患者信息
- `POST /api/appointments` - 创建预约
- `GET /api/appointments/{id}` - 获取预约详情
- `GET /api/doctors` - 获取医生列表
- `GET /api/schedules` - 获取排班信息
- `POST /api/medical-records` - 创建病历
- `GET /api/medical-records/{id}` - 获取病历
- `POST /api/prescriptions` - 创建处方
- `POST /api/charges` - 创建收费记录

### .NET 9特性应用
- Minimal API 简化路由定义
- Entity Framework Core 9 进行ORM
- Dependency Injection 依赖注入
- Middleware 中间件（日志、异常处理）
- Background Services 处理异步任务

### 数据访问层
- Repository模式封装数据访问
- 单元工作模式（Unit of Work）管理事务
- 数据验证和业务规则检查

## 非功能性需求

### 性能要求
- AI响应时间 < 3秒（90%请求）
- 页面首屏加载时间 < 2秒
- API响应时间 < 500ms（数据库查询）
- 支持并发用户数 ≥ 50
- 数据库查询优化（索引覆盖率 > 80%）
- 前端资源压缩和懒加载

### 安全要求
- **数据安全**
  - 患者隐私数据加密存储（AES-256）
  - 身份证号脱敏显示（320106****1234）
  - 电话号码脱敏（138****5678）
  - 数据库定期备份（每日）

- **访问控制**
  - API访问需要JWT身份验证
  - 角色权限管理（医生/前台/管理员）
  - 会话超时控制（30分钟无操作）
  - 防暴力破解（登录失败5次锁定）

- **日志审计**
  - 敏感操作日志记录（查看病历、修改档案等）
  - 异常访问监控和告警
  - 操作人员可追溯

- **防护措施**
  - SQL注入防护（参数化查询）
  - XSS攻击防护（输入过滤和转义）
  - CSRF防护（Token验证）
  - API限流（每用户100次/分钟）

### 可维护性
- **代码质量**
  - 遵循C#和TypeScript编码规范
  - 代码注释覆盖率 > 30%（关键逻辑必须注释）
  - 单元测试覆盖率 ≥ 60%
  - 代码复杂度控制（圈复杂度 < 15）

- **架构设计**
  - 模块化设计，低耦合高内聚
  - 清晰的分层架构（Controller/Service/Repository）
  - 统一的异常处理机制
  - 日志级别管理（Debug/Info/Warning/Error）

### 可扩展性
- **AI模型扩展**
  - 支持配置多个AI提供商
  - 统一的AI服务接口抽象
  - 模型热切换和AB测试

- **业务扩展**
  - 支持新增科室和业务流程
  - 插件化的诊疗模板
  - 自定义字段扩展

- **国际化**
  - 多语言支持框架（中文/英文）
  - 时区和日期格式适配
  - 货币单位配置

## 开发阶段规划

### 第一阶段：基础框架搭建（预计2周）
- **前端初始化**
  - Vue 3 + Vite项目搭建
  - Element UI Plus集成和主题配置
  - 基础布局和路由设计
  - Axios封装和API配置

- **后端初始化**
  - .NET 9 Web API项目创建
  - Entity Framework Core配置
  - SQLite数据库连接
  - 依赖注入容器配置

- **数据库设计**
  - 完成所有表结构设计
  - 创建数据库迁移脚本
  - 初始化测试数据（医生、科室、药品等）

- **AI集成**
  - DeepSeek/Qwen API接入
  - Prompt模板设计
  - 简单对话功能测试

### 第二阶段：核心业务开发（预计3周）
- **患者建档模块**（3天）
  - 前端建档表单和验证
  - 后端患者CRUD接口
  - AI辅助信息收集
  - 去重检测功能

- **预约挂号模块**（5天）
  - 科室医生查询界面
  - 排班号源管理
  - 预约创建和确认
  - AI智能推荐

- **医生看诊模块**（5天）
  - 患者信息查看
  - 病历记录和编辑
  - AI辅助诊断建议
  - 病历自动生成

### 第三阶段：完善和优化（预计2周）
- **处方管理**（3天）
  - 药品搜索和选择
  - 处方开具和审核
  - 药品相互作用检查

- **收费模块**（2天）
  - 费用计算和汇总
  - 收费记录管理
  - 发票生成

- **查询统计**（2天）
  - 患者就诊历史
  - 医生工作量统计
  - 收费报表

- **优化测试**（3天）
  - 性能优化和压力测试
  - 单元测试编写
  - Bug修复

### 第四阶段：部署上线（预计1周）
- **文档编写**
  - 用户操作手册
  - 系统部署文档
  - API接口文档

- **部署配置**
  - 生产环境配置
  - 数据库初始化
  - AI API密钥配置

- **测试验收**
  - 功能完整性测试
  - 用户验收测试
  - 试运行和问题修复

## 质量保证

### 测试策略
- **单元测试**：关键业务逻辑覆盖
- **集成测试**：API接口端到端测试
- **UI测试**：主要用户流程测试
- **性能测试**：并发和压力测试
- **安全测试**：漏洞扫描和渗透测试

### 验收标准
- 所有核心功能正常运行
- AI响应准确率 > 85%
- 系统稳定性测试通过（无崩溃运行24小时）
- 性能指标达标
- 安全测试无高危漏洞

## 风险评估

### 技术风险
- **AI模型稳定性**：API服务中断或响应慢
  - 应对：实现降级策略和备用模型

- **数据准确性**：AI提取信息错误
  - 应对：关键信息人工确认机制

- **并发性能**：高并发下系统响应慢
  - 应对：数据库优化、缓存策略

### 业务风险
- **医疗合规性**：诊疗流程不符合规范
  - 应对：咨询医疗专业人士，遵循行业标准

- **数据安全**：患者隐私泄露
  - 应对：严格的安全措施和权限控制

## 后续规划

### 功能扩展
- 电子处方签名和打印
- 检查检验单管理
- 医保对接接口
- 移动端应用
- 远程问诊功能

### 技术升级
- 引入更先进的AI模型
- 实时语音交互
- 医学知识图谱集成
- 智能诊断辅助系统